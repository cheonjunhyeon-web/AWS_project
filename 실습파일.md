## step1
새로 아이디를 만들어 프리티어로 실습을 진행하였다.   
먼저 WAF기능은 프리티어 지원이 없으므로, SQS부터 시작한다. 
<img width="1394" height="872" alt="image" src="https://github.com/user-attachments/assets/8cbba7f2-8837-461e-a292-563e86a1c23a" />
메시지를 설정하는 구성파트
표시 제한 시간 - Step Functions가 메시지를 가져가서 처리하는 동안, 다른 곳에서 중복으로 가져가지 못하게 숨겨두는 시간이다.  
메시지 보존 기간 - 처리되지 않은 로그가 대기열에 머물 수 있는 최대 기간이다.  
메시지 수신 대기 시간 - 메시지가 올 때까지 기다릴지 말지 결정한다.  

<img width="1236" height="328" alt="image" src="https://github.com/user-attachments/assets/52283756-566e-443d-9456-9a41bcaf00f0" />
암호화를 유지하는 것이 좋다.   
서버 측 암호화 (SSE) - 대기열에 저장되는 메시지를 AWS가 자동으로 암호화해주는 기능이다. 해커가 물리적 데이터 센터를 털더라도 내용을 볼 수 없게 보호한다.     
  
Encryption Key Type :  
  Amazon SQS 키 - 별도의 추가 비용이 없고 설정이 간편하다. 
  AWS KMS 키 - 보안 수준이 더 높고 암호화 키를 직접 관리할 수 있지만, KMS 호출 횟수에 따라 미세한 비용이 발생할 수 있다. 

<img width="1220" height="614" alt="image" src="https://github.com/user-attachments/assets/82f04915-2c6e-4a43-8027-3e52ac006390" />
현재 액세스 정책은 기본으로 설정한다. 아직 프로젝트 초기 단계이기 때문에 내가 권한을 부여해준 사람만 접근할 수 있게 만든다.   
추후에 람다 1번만 쓰고, Step Functions만 읽게하도록 세밀하게 제어할 예정이다. 

<img width="1768" height="820" alt="image" src="https://github.com/user-attachments/assets/f0f81cf0-d7b9-490c-a21b-9e48d9928415" />
첫번째로 SQS를 만들었고, 다음으로 데이터를 저장할 DynamoDB를 만들차례이다.
<img width="1513" height="615" alt="image" src="https://github.com/user-attachments/assets/94befb71-3b91-482a-b59d-c30e79c531fc" />
이름과 파티션 키, 정렬 키를 설정해준다.</br>
테이블 이름은 Security-DB</br>  
파티션 키는 attack_id</br>
정렬 키는 timestamp로 설정했다.</br> 

<img width="1631" height="513" alt="image" src="https://github.com/user-attachments/assets/bee9da51-0068-4576-a90d-886769bcfbac" />
제일 중요한 테이블 설정 파트이다. </br>
이때 기본 설정보다 설정 사용자 지정으로 하는 것이 좋다.</br> 
왜냐하면 비용적으로 효율적이며, 트래픽이 어느정도 발생 하는지 모르기 때문에 온디맨드 용량을 사용해주는 것이 확장성에 좋기 때문이다. </br>

이후 밑에 설정에서 삭제 방지 활성화를 눌러 실수로 삭제되지 않도록 만들고 DB생성을 완료한다. 

다음으로 빈 껍대기 Lambda를 3개 만들어줄 것이다.</br>
Log-Extractor-Lambda |	Python 3.12	 | 로그 필터링 및 SQS 전송</br>
Threat-Analyzer-Lambda |	Python 3.12	| 위험 점수 계산 (AI/로직)</br>
Security-Responder-Lambda |	Python 3.12	| WAF 차단, DB 저장, SNS 발송</br>
<img width="1579" height="676" alt="image" src="https://github.com/user-attachments/assets/ea6b0410-eb7d-4f2d-93c5-0465055757e2" />
<img width="1610" height="269" alt="image" src="https://github.com/user-attachments/assets/e2c09056-c54e-451b-b4a0-3944883a0fa5" />

아직 람다가 빈 깡통이기 때문에, SQS에 글을 쓰거나 DynamoDB에 저장할 권한이 없다. 가장 먼저 Log-Extractor가 SQS에 메시지를 보낼 수 있도록 권한을 준다.</br>
Log-Extractor-Lambda -> 구성 -> 권한 <br>
역할 이름에 있는 파랑색 링크 클릭 -> IAM 역할 링크로 들어가지며  정책 연결을 해주면 된다.<br>
람다는 기본적으로 CloudWatch Log 권한이 들어가있다. 이건 람다가 자기 로그를 남기기 위해 기본적으로 가져야 하는 권한이다. 여기에 SQS 권한을 추가해 줘야만 비로소 람다 1번이 일할 수 있는 조건이 완성된다. 

<img width="1588" height="316" alt="image" src="https://github.com/user-attachments/assets/2aaa21b0-6970-4a2c-8ef9-6ce83ad6b904" />
권한 추가 클릭 
<img width="1670" height="451" alt="image" src="https://github.com/user-attachments/assets/54dbfc70-5f1c-4f8b-a4ed-945d7c9e0035" />
AmazonSQSFullAccess체크후 추가를 한다.<br>
이후 다시 코드 창으로 오면 아래와 같은 그림으로 보일 것 이다. 
<img width="1390" height="533" alt="image" src="https://github.com/user-attachments/assets/695d2726-854b-47fb-a99e-6fbae5a4a1f7" />
여기에 코드를 작성할 차례이다. Log-Extractor-Lambda에는 로그에서 IP를 추출하고 SQS로 던지는 핵심 로직을 구성할 것 이다. <br> 

## step 2 
람다 코드 작성이 완료되면 Step functions를 설정해준다. <br>
<img width="1826" height="571" alt="image" src="https://github.com/user-attachments/assets/bcfe654e-b987-475c-beff-5017727186b0" />
<br> 생성을 누르면 아래 그림과 같이 나온다 . 
<img width="1893" height="780" alt="image" src="https://github.com/user-attachments/assets/568aa2d7-64de-49c0-925f-535776371e5b" />
<br> 우리는 lambda에서 위험 필터링을 통해 step functions으로 넘어왔기에 start 다음 바로 병렬로 lambda 3개가 동시에 처리되도록 만들어야한다. <br>
<img width="1533" height="653" alt="image" src="https://github.com/user-attachments/assets/7ef76876-f167-432a-a456-43bf5495915b" /><br>
lambda를 만들고, 이름도 변경해줬다. 오른쪽 구성 탭을 보면 페이로드에서 상태 입력을 페이로드로 사용이 선택되어 있다. 이 의미는 2번 람다가 보내준 <br>
{"ip": "1.1.1.1", "attack_type": "SQL Injection"}같은 정보를 그대로 3,4,5번 람다에게 토스하겠다는 뜻이다. <br>
<img width="1616" height="813" alt="image" src="https://github.com/user-attachments/assets/5acafbac-e49b-4064-a2bb-64136146e458" />
<br> 
정상적으로 생성이 되었다. 이다음 코드를 작성하여 전체 자동화 시스템을 완성 시킬 수 있다. 
<br><br>
## step 3
SNS로 사용자 이메일로 보안 경보 메시지를 보낼수 있도록 SNS 만들어줘야한다. <br>
<img width="1313" height="410" alt="image" src="https://github.com/user-attachments/assets/4060145b-b835-4b6f-8f48-15068f845f30" />
다음 단계를 눌러 생성을 시작한다. <br>
<img width="1176" height="505" alt="image" src="https://github.com/user-attachments/assets/9c2c4e1f-edb7-4388-bdeb-ee73244a0e9a" />
<br>
속도와 처리량이 더 빠른 표준 유형으로 선택한다 <br>
주제 생성을 한다.  생성된 주제 상세 화면에서 구독 생성을 눌러 이메일을 받도록 설정 한다.
<img width="1633" height="390" alt="image" src="https://github.com/user-attachments/assets/6a3b36d7-b406-450d-b782-ec79bfd6d82b" />
<br> 생성하고 나면 내 이메일로 사진과 같은 형태로 나온다. 
<img width="985" height="484" alt="image" src="https://github.com/user-attachments/assets/c2e38a57-4536-438f-884c-e4fde06b3e8e" />
구독이 정상적으로 되었다는 문구가 적혀있다.<br>
이후 snslambda가 SNS를 쓸 수 있게 권한 허용을 해줘야한다 .<br>
<img width="1601" height="301" alt="image" src="https://github.com/user-attachments/assets/c36aaee4-e364-4d37-9a21-30024df5f6cb" />

## step 4
WAF 생성 <br>
<img width="1885" height="377" alt="image" src="https://github.com/user-attachments/assets/a26f4154-b0cf-4c91-a16a-6f509182ad14" />
WAF에서 IP 세트를 클릭하여 들어간다. IP 주소 세트 생성을 누르고ㅓ Malicious-Ip-Set으로 이름을 짓는다. <br>
<img width="1247" height="234" alt="image" src="https://github.com/user-attachments/assets/b2975533-097a-4468-b9a7-d15ce89c07f5" />
<br> Ip 세트를 만들었으니 Web ACL를 생성해줘야 한다. <br>
<img width="1362" height="258" alt="image" src="https://github.com/user-attachments/assets/f1d71b25-db35-4b84-add7-10108ae10f34" />
<br> 형식상 WAF는 ABL(로드밸런서)나 API Gateway같은 서비스의 앞 문에 붙어서 작동되어서 선택해야한다. 하지만 지금 생성하지 않았기에 보호할 리소스에서는 건너뛰기를 한다. <br>
우리는 오른쪽에 있는 API등 서비스를 보호할 것이다. 선택 후 넘어간다. 초기 보호 기능 선택 부분이 나오는데, 아직 우리는 초기 상태이기도 하고, 너무 비싸기 때문에 직접 구축을 선택. <br>
오랜쪽에서 규칙 추가를 할 수 있다. 작업은 차단이니 Block 이고, 우리가 위에서 Ip세트를 만들었기에, 기존 IP세트 사용 버튼을 클릭하여 IP세트 이름을 지정해준다. 
<img width="670" height="807" alt="image" src="https://github.com/user-attachments/assets/b7c3f2e6-c38e-48cb-92cb-4f19e0e9bfde" />
<br> 설정이 완료된다면 생성을 누른다. <br>
<img width="1585" height="241" alt="image" src="https://github.com/user-attachments/assets/080998ed-6b88-4cfe-bfa3-43eee4603b5b" />
<br> 이제 Security-Responder lambda에서 waf로 차단할 ip를 넘기고, waf에서 IP를 자동으로 처리할 수 있도록 코딩하면 된다. 


## step 5
매일 아침 정기보고 시스템 만들기 <br>
현재 공격이 들어오자마자 즉시 메일을 보내는 로직으로 구성되어 있다. 아침마다 총 공격 건수를 말해주는 것이 좋을 것 같아서 만들기로 했다. 먼저 Lambda를 하나더 생성한다 이때 만드는 Lambda는 step Functions에서 관리되는 것이 아닌, 단독으로 실행되는 것이다. 
<br> 만드는 방식은 Eventbridge와 함께 사용하는 것이다. Eventbridge에서 스케줄러가 지정 시간마다 실행해줄것임.
만드는 순서는 이전과 똑같으니 간단하게 설명하겠다. <br>
1. Daily-Summarizer-lambda 생성
2. 정책 설정에서 DB정책과 SNS정책을 추가해준다.
3. Lambda 코딩
4. 코딩이 끝나면 구성탭에서 트리거 추가를 누른다.
5. EventBridge를 선택해여 아래의 그림처럼 구성한다.
   <img width="1567" height="710" alt="image" src="https://github.com/user-attachments/assets/25b20e01-17c0-44da-a6a4-4e6bad82befd" />
<img width="1216" height="600" alt="image" src="https://github.com/user-attachments/assets/a80000c8-8dbd-4990-b4ca-bf5bd63a7d2a" />
