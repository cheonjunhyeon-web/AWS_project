## step1
새로 아이디를 만들어 프리티어로 실습을 진행하였다.   
먼저 WAF기능은 프리티어 지원이 없으므로, SQS부터 시작한다. 
<img width="1394" height="872" alt="image" src="https://github.com/user-attachments/assets/8cbba7f2-8837-461e-a292-563e86a1c23a" />
메시지를 설정하는 구성파트
표시 제한 시간 - Step Functions가 메시지를 가져가서 처리하는 동안, 다른 곳에서 중복으로 가져가지 못하게 숨겨두는 시간이다.  
메시지 보존 기간 - 처리되지 않은 로그가 대기열에 머물 수 있는 최대 기간이다.  
메시지 수신 대기 시간 - 메시지가 올 때까지 기다릴지 말지 결정한다.  

<img width="1236" height="328" alt="image" src="https://github.com/user-attachments/assets/52283756-566e-443d-9456-9a41bcaf00f0" />
암호화를 유지하는 것이 좋다.   
서버 측 암호화 (SSE) - 대기열에 저장되는 메시지를 AWS가 자동으로 암호화해주는 기능이다. 해커가 물리적 데이터 센터를 털더라도 내용을 볼 수 없게 보호한다.     
  
Encryption Key Type :  
  Amazon SQS 키 - 별도의 추가 비용이 없고 설정이 간편하다. 
  AWS KMS 키 - 보안 수준이 더 높고 암호화 키를 직접 관리할 수 있지만, KMS 호출 횟수에 따라 미세한 비용이 발생할 수 있다. 

<img width="1220" height="614" alt="image" src="https://github.com/user-attachments/assets/82f04915-2c6e-4a43-8027-3e52ac006390" />
현재 액세스 정책은 기본으로 설정한다. 아직 프로젝트 초기 단계이기 때문에 내가 권한을 부여해준 사람만 접근할 수 있게 만든다.   
추후에 람다 1번만 쓰고, Step Functions만 읽게하도록 세밀하게 제어할 예정이다. 

<img width="1768" height="820" alt="image" src="https://github.com/user-attachments/assets/f0f81cf0-d7b9-490c-a21b-9e48d9928415" />
첫번째로 SQS를 만들었고, 다음으로 데이터를 저장할 DynamoDB를 만들차례이다.
<img width="1513" height="615" alt="image" src="https://github.com/user-attachments/assets/94befb71-3b91-482a-b59d-c30e79c531fc" />
이름과 파티션 키, 정렬 키를 설정해준다.</br>
테이블 이름은 Security-DB</br>  
파티션 키는 attack_id</br>
정렬 키는 timestamp로 설정했다.</br> 

<img width="1631" height="513" alt="image" src="https://github.com/user-attachments/assets/bee9da51-0068-4576-a90d-886769bcfbac" />
제일 중요한 테이블 설정 파트이다. </br>
이때 기본 설정보다 설정 사용자 지정으로 하는 것이 좋다.</br> 
왜냐하면 비용적으로 효율적이며, 트래픽이 어느정도 발생 하는지 모르기 때문에 온디맨드 용량을 사용해주는 것이 확장성에 좋기 때문이다. </br>

이후 밑에 설정에서 삭제 방지 활성화를 눌러 실수로 삭제되지 않도록 만들고 DB생성을 완료한다. 

다음으로 빈 껍대기 Lambda를 3개 만들어줄 것이다.</br>
Log-Extractor-Lambda |	Python 3.12	 | 로그 필터링 및 SQS 전송</br>
Threat-Analyzer-Lambda |	Python 3.12	| 위험 점수 계산 (AI/로직)</br>
Security-Responder-Lambda |	Python 3.12	| WAF 차단, DB 저장, SNS 발송</br>
<img width="1579" height="676" alt="image" src="https://github.com/user-attachments/assets/ea6b0410-eb7d-4f2d-93c5-0465055757e2" />
<img width="1610" height="269" alt="image" src="https://github.com/user-attachments/assets/e2c09056-c54e-451b-b4a0-3944883a0fa5" />

아직 람다가 빈 깡통이기 때문에, SQS에 글을 쓰거나 DynamoDB에 저장할 권한이 없다. 가장 먼저 Log-Extractor가 SQS에 메시지를 보낼 수 있도록 권한을 준다.</br>
Log-Extractor-Lambda -> 구성 -> 권한 <br>
역할 이름에 있는 파랑색 링크 클릭 -> IAM 역할 링크로 들어가지며  정책 연결을 해주면 된다.<br>
람다는 기본적으로 CloudWatch Log 권한이 들어가있다. 이건 람다가 자기 로그를 남기기 위해 기본적으로 가져야 하는 권한이다. 여기에 SQS 권한을 추가해 줘야만 비로소 람다 1번이 일할 수 있는 조건이 완성된다. 

<img width="1588" height="316" alt="image" src="https://github.com/user-attachments/assets/2aaa21b0-6970-4a2c-8ef9-6ce83ad6b904" />
권한 추가 클릭 
<img width="1670" height="451" alt="image" src="https://github.com/user-attachments/assets/54dbfc70-5f1c-4f8b-a4ed-945d7c9e0035" />
AmazonSQSFullAccess체크후 추가를 한다.<br>
이후 다시 코드 창으로 오면 아래와 같은 그림으로 보일 것 이다. 
<img width="1390" height="533" alt="image" src="https://github.com/user-attachments/assets/695d2726-854b-47fb-a99e-6fbae5a4a1f7" />
여기에 코드를 작성할 차례이다. Log-Extractor-Lambda에는 로그에서 IP를 추출하고 SQS로 던지는 핵심 로직을 구성할 것 이다. <br> 

## step 2 
람다 코드 작성이 완료되면 Step functions를 설정해준다. <br>
<img width="1826" height="571" alt="image" src="https://github.com/user-attachments/assets/bcfe654e-b987-475c-beff-5017727186b0" />
<br> 생성을 누르면 아래 그림과 같이 나온다 . 
<img width="1893" height="780" alt="image" src="https://github.com/user-attachments/assets/568aa2d7-64de-49c0-925f-535776371e5b" />
<br> 우리는 lambda에서 위험 필터링을 통해 step functions으로 넘어왔기에 start 다음 바로 병렬로 lambda 3개가 동시에 처리되도록 만들어야한다. <br>
<img width="1533" height="653" alt="image" src="https://github.com/user-attachments/assets/7ef76876-f167-432a-a456-43bf5495915b" /><br>
lambda를 만들고, 이름도 변경해줬다. 오른쪽 구성 탭을 보면 페이로드에서 상태 입력을 페이로드로 사용이 선택되어 있다. 이 의미는 2번 람다가 보내준 <br>
{"ip": "1.1.1.1", "attack_type": "SQL Injection"}같은 정보를 그대로 3,4,5번 람다에게 토스하겠다는 뜻이다. <br>
<img width="1616" height="813" alt="image" src="https://github.com/user-attachments/assets/5acafbac-e49b-4064-a2bb-64136146e458" />
<br> 
정상적으로 생성이 되었다. 이다음 코드를 작성하여 전체 자동화 시스템을 완성 시킬 수 있다. 




